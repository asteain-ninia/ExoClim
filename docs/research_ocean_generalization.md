# 調査報告: 大気循環セル数に基づく海流生成の一般化

## 1. 結論

**ユーザー様のアプローチ（多セル対応・アトラクター方式）を採用すべきです。**

「緯度30度で東へ曲がる」という地球のルールは、地球が「3つの循環セル（ハドレー、フェレル、極）」を持っていることに由来します。これを一般化するには、**惑星のパラメータから循環セルの数 $N$ を算出し、その境界線を海流エージェントのアトラクター（誘導線）として動的に定義する**方法が最適です。

この手法により、「自転が速い惑星＝セルが多く、縞模様のような海流（木星型）」や、「自転が遅い惑星＝セルが1つで、全球規模の巨大な海流（金星型）」を自然に表現できます。

---

## 2. 物理モデルの一般化ロジック

### 2.1 循環セル数 $N$ の算出

すでに `circulation.ts` に実装されている通り、以下の比例関係を用います。

$$ N \approx 3.0 \times \left( \frac{R_{planet}}{R_{earth}} \right) \times \sqrt{\frac{P_{rot\_earth}}{P_{rot\_planet}}} $$

*   地球 ($N=3$): 半径6371km, 自転24h
*   自転が速い (例: 10h) $\rightarrow$ $N$ は増える (5〜6)
*   自転が遅い (例: 100h) $\rightarrow$ $N$ は減る (1〜2)

### 2.2 帯状風（Zonal Winds）と海流の支配領域

各セルは、コリオリ力によって交互に「東風（Easterlies）」と「西風（Westerlies）」を生み出します。海流は風成循環（Wind-driven circulation）が主であるため、海流エージェントの基本移動ベクトルはこの風向に従います。

**一般化された帯状領域の定義:**

赤道から極に向かって $i = 0, 1, ..., N-1$ 番目のセルとします。

1.  **セルの緯度幅:** $\Delta \phi = 90^\circ / N$
2.  **境界緯度:** $\phi_{boundary}(i) = i \times \Delta \phi$

**風向と海流の方向:**

| セル番号 $i$ | 地球での対応 | 風向 | 海流の基本ベクトル | 備考 |
| :--- | :--- | :--- | :--- | :--- |
| **0** (赤道〜$\phi_1$) | ハドレー循環 | 東風 (貿易風) | **西向き (Westward)** | 赤道海流 |
| **1** ($\phi_1$〜$\phi_2$) | フェレル循環 | 西風 (偏西風) | **東向き (Eastward)** | 偏西風皮流 |
| **2** ($\phi_2$〜$\phi_3$) | 極循環 | 東風 | **西向き (Westward)** | 極循環流 |
| ... | ... | ... | ... | 交互に入れ替わる |

つまり、**偶数番目のセルは西へ、奇数番目のセルは東へ**流れるアトラクターを持ちます。

---

## 3. アトラクター（誘導線）の実装設計

既存の `Impact Point` や `Target Lat` の概念を拡張し、以下のように再設計することを提案します。

### 3.1 ターゲット緯度（Attractor Latitude）の計算

各エージェントは、自分が現在属している「循環バンド」の中心緯度をターゲットとして流れます。

$$ \text{TargetLat}(i) = \text{Sign(Lat)} \times \left( (i + 0.5) \times \Delta \phi \right) $$

*   $i=0$ (ハドレー帯) のエージェントは、緯度 $0.5 \times \Delta \phi$ (地球なら15度付近) を目指しながら西へ流れる。
*   $i=1$ (フェレル帯) のエージェントは、緯度 $1.5 \times \Delta \phi$ (地球なら45度付近) を目指しながら東へ流れる。

### 3.2 境界での転向（Turning Logic）の一般化

「30度で東に曲がる」という挙動は、以下のように物理的に説明・実装できます。

1.  **西岸境界流 (Western Boundary Current):**
    *   赤道海流（西向き）が大陸に衝突。
    *   コリオリ力により、北半球なら「右」、南半球なら「左」に曲がる性質がある。
    *   つまり、**極方向へ沿岸を這い上がる (Poleward Crawl)**。
    *   **転向の条件:** エージェントが沿岸を這い上がり、セルの境界緯度 $\phi_{boundary}(1)$ (地球なら30度) を超えた瞬間、支配的な風向が「東向き」に逆転する。
    *   **結果:** エージェントは大陸から離れ、東向きのアトラクターに捕捉される。

2.  **東岸境界流 (Eastern Boundary Current):**
    *   偏西風皮流（東向き）が大陸に衝突。
    *   コリオリ力と圧力勾配により、**赤道方向へ沿岸を這い下りる (Equatorward Crawl)**。
    *   **転向の条件:** 赤道方向へ移動し、境界緯度 $\phi_{boundary}(1)$ を割り込んだ瞬間、風向が「西向き」に逆転する。
    *   **結果:** エージェントは再び赤道海流（西向き）に合流する。

### 3.3 エージェントのステートマシン拡張案

現在の `ECC` / `EC` という固定的な区分を廃止し、以下の汎用ステートにします。

*   **ZONAL_FLOW (帯状流):**
    *   現在の緯度に基づき、偶数セルなら西へ、奇数セルなら東へ流れる。
    *   ターゲットは現在のセルの中心緯度。
*   **BOUNDARY_CRAWL (境界流):**
    *   大陸に衝突した場合に移行。
    *   **西壁に衝突 (東進中):** 赤道方向へ移動（緯度を下げる）。
    *   **東壁に衝突 (西進中):** 極方向へ移動（緯度を上げる）。
    *   セル境界線を跨いだら `ZONAL_FLOW` に復帰し、新しいセルの風向に従う。

---

## 4. 推奨される実装ステップ

既存の `computeOceanCurrents` を以下の順でリファクタリングすることを推奨します。

1.  **セル情報の取得:** `circulation.ts` から `cellCount` を確実に受け取る。
2.  **風向マップの仮想化:** グリッドの各地点における「基本風向（西/東）」を返す関数を作成する（緯度とセル数のみに依存）。
3.  **エージェント統合:** `ECC`, `EC_N`, `EC_S` を統合し、単一の `Agent` クラスにする。初期スポーン位置のみを制御する。
4.  **這行ロジックの更新:**
    *   現在は「ターゲット緯度との差」だけで動いている。
    *   これを「壁に当たったら、コリオリ力に従って南北移動する」というルールに変更する。
    *   具体的には、**西向き移動中に壁→高緯度へ**、**東向き移動中に壁→低緯度へ**。

この設計により、3セル（地球）だけでなく、1セル（金星）や5セル（速い自転）の場合でも、自動的に適切な海流パターン（亜熱帯循環、亜寒帯循環など）が形成されるようになります。
